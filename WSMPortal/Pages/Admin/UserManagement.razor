@page "/admin/userManagement"
@inject IUserEndpoint userEndpoint
@inject IJobTitleEndpoint jobTitleEndpoint
@inject IUserEndpoint userEndpoint
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager navManager
@attribute [Authorize(Roles = "Admin")]

<h1>User Management</h1>

@if (string.IsNullOrWhiteSpace(errorMessage) == false)
{
    <div class="alert alert-danger">
        @errorMessage
    </div>
}

@if (users is not null && roles is not null)
{
    <div class="">
        <div class="row">
            <div class="col-sm">
                <EditForm Model="selectedUserRolePair" OnValidSubmit="AddSelectedRole">
                    <div class="row">
                        <label for="user-id" class="col-md-2 col-form-label">Users: </label>
                        <div class="col-md-10">
                            <MyInputRadioGroup id="users" @bind-Value="selectedUserRolePair.Id" class="">
                                @foreach (var user in users)
                                {
                                <div class="">
                                    <InputRadio Value="@user.Id" id="@user.Id" />
                                    <label for="@user.Id">@user.FullName</label>
                                </div>
                                }
                            </MyInputRadioGroup>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <label for="role-name" class="col-md-2 col-form-label">Roles: </label>
                        <div class="col-md-10">
                            <MyInputRadioGroup id="roles" @bind-Value="selectedUserRolePair.RoleName">
                                @foreach (var role in roles)
                                {
                                <div class="">
                                    <InputRadio Value="@role.Value" id="@role.Value" />
                                    <label for="@role.Value">@role.Value</label>
                                </div>
                                }
                            </MyInputRadioGroup>
                        </div>
                    </div> 
                    <button type="submit" class="btn btn-primary">
                        Add Selected Role
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="RemoveSelectedRole">
                        Remove Selected Role
                    </button>
                </EditForm>
            </div>

            <div class="col-sm">
                <Virtualize Items="users" Context="user" OverscanCount="10">
                    <div>
                        Username: @user.FullName
                        @if (string.IsNullOrWhiteSpace(user.RoleList))
                        {
                            <text> Roles: This User has No Roles</text>
                        }
                        else
                        {
                            <text> Roles: @user.RoleList</text>
                        }
                        <br />
                    </div>
                </Virtualize>
            </div>
        </div>
    </div>
}

@if (users is not null && jobs is not null)
{
    <div class="">
        <div class="row">
            <div class="col-sm">
                <EditForm Model="selectedUserJobPair" OnValidSubmit="AddSelectedJob">
                    <div class="row">
                        <label for="user-id" class="col-md-2 col-form-label">User: </label>
                        <div class="col-md-10">
                            <MyInputRadioGroup id="users" @bind-Value="selectedUserJobPair.Id">
                                @foreach (var user in users)
                                {
                                    <div>
                                        <InputRadio Value="@user.Id" id="@user.Id" />
                                        <label for="@user.Id">@user.FullName</label>
                                    </div>
                                }
                            </MyInputRadioGroup>
                        </div>
                    </div>

                    <div class="row">
                        <label for="job-id" class="col-md-2 col-form-label">Job Title: </label>
                        <div class="col-md-10">
                            <MyInputRadioGroup id="jobs" @bind-Value="selectedUserJobPair.JobId">
                                @foreach (var job in jobs)
                                {
                                    <div>
                                        <InputRadio Value="@job.Id" id="@job.Id" />
                                        <label for="@job.Id">@job.JobName</label>
                                    </div>
                                }
                            </MyInputRadioGroup>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        Add Selected Job
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="RemoveSelectedJob">
                        Remove Selected Job
                    </button>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private string errorMessage = "";
    private UserRolePairModel selectedUserRolePair = new();
    private UserJobPairModel selectedUserJobPair = new();

    private List<UserModel> users;
    private const string UserListName = "userList";
    private const string UserCacheDate = "userCacheDate";
    private double totalMinutesUser = 0;

    private List<JobTitleModel> jobs;
    private JobTitleModel selectedJob;
    private const string JobListName = "jobList";
    private const string JobCacheDate = "jobCacheDate";
    private double totalMinutesJob = 0;

    private Dictionary<string, string> roles;
    private const string RoleListName = "roleList";
    private const string RoleCacheDate = "roleCacheDate";
    private double totalMinutesRole = 0;

    protected override async Task OnInitializedAsync()
    {
        users = await localStorage.GetItemAsync<List<UserModel>>(UserListName);
        DateTime? cacheDateUser = await localStorage.GetItemAsync<DateTime?>(UserCacheDate);

        jobs = await localStorage.GetItemAsync<List<JobTitleModel>>(JobListName);
        DateTime? cacheDateJob = await localStorage.GetItemAsync<DateTime?>(JobCacheDate);

        roles = await localStorage.GetItemAsync<Dictionary<string, string>>(RoleListName);
        DateTime? cacheDateRole = await localStorage.GetItemAsync<DateTime?>(RoleCacheDate);

        if (cacheDateUser is not null)
        {
            totalMinutesUser = DateTime.UtcNow.Subtract((DateTime)cacheDateUser).TotalMinutes;
        }

        if (cacheDateJob is not null)
        {
            totalMinutesJob = DateTime.UtcNow.Subtract((DateTime)cacheDateJob).TotalMinutes;
        }

        if (cacheDateRole is not null)
        {
            totalMinutesRole = DateTime.UtcNow.Subtract((DateTime)cacheDateRole).TotalMinutes;
        }

        if (users is null || jobs is null || roles is null || 
            cacheDateUser is null || cacheDateJob is null || cacheDateRole is null ||
            totalMinutesUser > 10 || totalMinutesJob > 10 || totalMinutesRole > 10)
        {
            try
            {
                users = await userEndpoint.GetAllAsync();
                await localStorage.SetItemAsync(UserListName, users);
                await localStorage.SetItemAsync(UserCacheDate, DateTime.UtcNow);
                jobs = await jobTitleEndpoint.GetAllAsync();
                await localStorage.SetItemAsync(JobListName, jobs);
                await localStorage.SetItemAsync(JobCacheDate, DateTime.UtcNow);
                roles = await userEndpoint.GetAllRolesAsync();
                await localStorage.SetItemAsync(RoleListName, roles);
                await localStorage.SetItemAsync(RoleCacheDate, DateTime.UtcNow);
            }
            catch (Exception ex)
            {
                errorMessage = ex.Message;
            }
        }
    }

    private async Task AddSelectedRole()
    {
        try
        {
            await userEndpoint.AddUserToRoleAsync(selectedUserRolePair.Id, selectedUserRolePair.RoleName);
        }
        catch
        {
            errorMessage = "A User Or A Role Must Be Selected.";
        }
    }

    private async Task RemoveSelectedRole()
    {
        try
        {
            await userEndpoint.RemoveUserFromRoleAsync(selectedUserRolePair.Id, selectedUserRolePair.RoleName);
        }
        catch
        {
            errorMessage = "A User Or A Role Must Be Selected.";
        }  
    }

    private async Task AddSelectedJob()
    {
        try
        {
            UserModel user = new()
            {
                Id = selectedUserJobPair.Id,
                JobTitleId = selectedUserJobPair.JobId
            };

            await userEndpoint.UpdateUserJobTitleIdAsync(user);
        }
        catch
        {
            errorMessage = "A User Or A Job Title Must Be Selected.";
        }
    }

    private async Task RemoveSelectedJob()
    {
        try
        {
            UserModel user = new()
            {
                Id = selectedUserJobPair.Id,
                JobTitleId = null
            };

            await userEndpoint.UpdateUserJobTitleIdAsync(user);
        }
        catch
        {
            errorMessage = "A User Or A Job Title Must Be Selected.";
        }
    }
}
